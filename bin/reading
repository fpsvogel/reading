#!/usr/bin/env ruby

# Starts the reading statistics interactive CLI, if a CSV file path arg is given.
# If a CSV string is given instead, then parsing output (item hashes) is displayed.
#
# Usage:
# Run on the command line:
#   reading "<CSV file path or string>" "<optional comma-separated names of enabled columns>"
#
# Examples:
#   reading /home/felipe/reading.csv
#   reading /home/felipe/reading.csv 'head, sources'
#   reading '3|ğŸ“•Trying|Little Library 1970147288'
#   reading 'ğŸ“•Trying|Little Library 1970147288' 'head, sources'

require_relative "../lib/reading"
require "amazing_print"
require "readline"
require "pastel"
require "debug"

EXIT_COMMANDS = %w[exit e quit q]
pastel = Pastel.new

input = ARGV[0]
unless input
  raise ArgumentError,
    "Argument required, either a CSV file path or a CSV string. Examples:\n" \
    "parsereading /home/felipe/reading.csv\n" \
    "parsereading '3|ğŸ“•Trying|Little Library 1970147288'"
end

config = {}
if ARGV[1]
  enabled_columns = ARGV[1].split(",").map(&:strip).map(&:to_sym)
  config = { enabled_columns: }
end

input_is_csv_path = input.end_with?('.csv') || input.include?('/')

if input_is_csv_path
  items = Reading.parse(path: input, config:, item_view: false)

  loop do
    raw_input = Readline.readline(pastel.bright_cyan("> "), true)

    exit if EXIT_COMMANDS.include?(raw_input)

    input = raw_input.presence
    next if raw_input.blank?

    puts Reading.stats(input:, items:, result_formatters: true)
  end
else # CSV string arg
  item_hashes = Reading.parse(lines: input, config:, hash_output: true, item_view: false)

  ap item_hashes
end
